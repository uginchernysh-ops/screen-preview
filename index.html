<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=5.0, user-scalable=yes">
  <title>Screen Preview с масштабированием</title>
  <style>
    :root {
      --base-size: 16px;
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --text-color: #ecf0f1;
      --bg-overlay: rgba(44,62,80,0.85);
      --container-bg: rgba(44,62,80,0.7);
      --panel-bg: rgba(52,73,94,0.8);
      --border-radius: 1.5rem;
      --spacing-xs: 0.5rem;
      --spacing-sm: 1rem;
      --spacing-md: 1.5rem;
      --spacing-lg: 2rem;
      --spacing-xl: 3rem;
      --font-size-sm: 1rem;
      --font-size-md: 1.25rem;
      --font-size-lg: 1.5rem;
      --font-size-xl: 2rem;
      --font-size-xxl: 2.5rem;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html { 
      font-size: var(--base-size);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('images/Back.jpg') no-repeat center center fixed;
      background-size: cover;
      color: var(--text-color);
      min-height: 100vh;
      line-height: 1.6;
      position: relative;
      overflow-x: hidden;
      padding: var(--spacing-sm);
    }
    
    body::before { 
      content: ''; 
      position: absolute; 
      inset: 0; 
      background: var(--bg-overlay); 
      z-index: -1; 
    }

    /* Каркас приложения */
    .app-shell {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      max-width: 100%;
      margin: 0 auto;
    }

    /* Левая панель */
    .sidebar {
      background: var(--container-bg);
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      box-shadow: 0 0.875rem 2.25rem rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-md);
      order: 2;
    }
    
    .logo { 
      width: 100%; 
      max-width: 22.5rem; 
      height: auto; 
      border-radius: 0.75rem; 
    }
    
    .app-title { 
      font-size: var(--font-size-xxl); 
      color: var(--primary-color); 
      text-align: center; 
    }
    
    .app-subtitle { 
      font-size: var(--font-size-lg); 
      opacity: 0.85; 
      text-align: center; 
    }

    /* Правая область */
    .main {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      order: 1;
    }

    .interface-container {
      width: 100%;
      background: var(--container-bg);
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      box-shadow: 0 0.875rem 2.25rem rgba(0,0,0,0.35);
    }

    header { 
      text-align: left; 
      margin-bottom: var(--spacing-md); 
      padding-bottom: var(--spacing-xs); 
      border-bottom: 1px solid rgba(255,255,255,0.1); 
    }
    
    h1 { 
      font-size: var(--font-size-xl); 
      margin-bottom: var(--spacing-xs); 
      color: var(--primary-color); 
    }
    
    .subtitle { 
      font-size: var(--font-size-md); 
      opacity: 0.85; 
    }

    .main-content { 
      display: flex; 
      flex-direction: column; 
      gap: var(--spacing-md); 
    }

    .control-panel {
      width: 100%;
      background: var(--panel-bg);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 1.875rem 5.3125rem rgba(0,0,0,0.25);
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
    }
    
    .control-group { 
      width: 100%; 
    }
    
    h2 { 
      font-size: var(--font-size-lg); 
      margin-bottom: var(--spacing-sm); 
      color: var(--primary-color); 
    }
    
    label { 
      display: block; 
      margin-bottom: var(--spacing-xs); 
      font-weight: 600; 
      font-size: var(--font-size-md); 
    }

    select, input[type="file"], input[type="range"], input[type="color"] {
      width: 100%; 
      padding: var(--spacing-sm); 
      margin-bottom: var(--spacing-sm); 
      border: none; 
      border-radius: 1.125rem;
      background: var(--secondary-color); 
      color: var(--text-color); 
      font-size: var(--font-size-sm);
    }
    
    input[type="range"] { 
      padding: 0; 
      height: 2.25rem; 
      -webkit-appearance: none; 
      background: #34495e; 
      border-radius: 1.5rem; 
    }
    
    input[type="range"]::-webkit-slider-thumb { 
      -webkit-appearance: none; 
      width: 2rem; 
      height: 2rem; 
      border-radius: 50%; 
      background: var(--primary-color); 
      cursor: pointer; 
    }
    
    button {
      width: 100%; 
      padding: var(--spacing-sm); 
      background: var(--primary-color); 
      color: white; 
      border: none; 
      border-radius: 1.125rem;
      font-size: var(--font-size-md); 
      cursor: pointer; 
      transition: background 0.3s; 
      margin-bottom: var(--spacing-xs);
    }
    
    button:hover, button:focus { 
      background: #2980b9; 
    }

    .row-full { 
      width: 100%; 
    }
    
    .preview-section { 
      width: 100%; 
    }

    .preview-container {
      position: relative;
      width: 100%;
      height: 50vh;
      min-height: 18.75rem;
      background: rgba(0,0,0,0.35);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: inset 0 0 5.625rem rgba(0,0,0,0.5);
    }

    #screenContainer { 
      position: relative; 
      transform-origin: center center; 
      transition: transform 0.2s ease; 
    }
    
    #maskImage, #fallbackCanvas { 
      position: absolute; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 1; 
      pointer-events: none; 
    }
    
    #videoPlayer {
      position: absolute; 
      inset: 0; 
      width: 100%; 
      height: 100%;
      object-fit: contain; 
      object-position: center;
      z-index: 2;
    }
    
    #previewCanvas { 
      position: absolute; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 2; 
    }

    .loading-indicator {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.7); 
      color: white; 
      padding: var(--spacing-md); 
      border-radius: 1.125rem; 
      z-index: 5; 
      display: none;
      font-size: var(--font-size-md);
      text-align: center;
    }
    
    .placeholder-message {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%);
      text-align: center; 
      color: rgba(255,255,255,0.6); 
      z-index: 0;
      font-size: var(--font-size-md);
      padding: var(--spacing-md);
    }

    .screen-info {
      background: var(--panel-bg); 
      padding: var(--spacing-md); 
      border-radius: var(--border-radius); 
      box-shadow: 0 1.875rem 5.3125rem rgba(0,0,0,0.25); 
      margin-top: var(--spacing-md);
    }
    
    .info-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(13.125rem, 1fr)); 
      gap: var(--spacing-sm); 
    }
    
    .info-item { 
      background: rgba(44,62,80,0.5); 
      padding: var(--spacing-sm); 
      border-radius: 1.125rem; 
    }
    
    .info-label { 
      font-size: var(--font-size-sm); 
      opacity: 0.7; 
      margin-bottom: 0.5rem; 
    }
    
    .info-value { 
      font-size: var(--font-size-md); 
      font-weight: 700; 
    }

    .error-message { 
      color: #e74c3c; 
      margin-top: var(--spacing-xs); 
      display: none; 
      font-size: var(--font-size-sm); 
    }
    
    .color-preview { 
      width: 4rem; 
      height: 4rem; 
      border-radius: 0.875rem; 
      border: 0.25rem solid var(--text-color); 
      margin: 0 auto;
    }

    /* Планшеты и небольшие ноутбуки */
    @media (min-width: 768px) {
      :root {
        --base-size: 17px;
      }
      
      .app-shell {
        flex-direction: row;
        max-width: 95vw;
      }
      
      .sidebar {
        width: 22rem;
        position: sticky;
        top: var(--spacing-md);
        max-height: calc(100vh - 2 * var(--spacing-md));
        overflow: auto;
        order: 1;
      }
      
      .main {
        flex: 1;
        order: 2;
      }
      
      .control-panel {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .preview-container {
        height: 60vh;
      }
    }

    /* Десктопы */
    @media (min-width: 1024px) {
      :root {
        --base-size: 18px;
      }
      
      .app-shell {
        max-width: 90rem;
        padding: var(--spacing-md);
      }
      
      .control-panel {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .preview-container {
        height: 65vh;
      }
    }

    /* Большие экраны */
    @media (min-width: 1440px) {
      :root {
        --base-size: 20px;
      }
      
      .preview-container {
        height: 70vh;
      }
    }

    /* Улучшения для мобильной навигации */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 3rem;
      height: 3rem;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    @media (max-width: 767px) {
      .mobile-menu-toggle {
        display: block;
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 80%;
        max-width: 20rem;
        height: 100vh;
        z-index: 900;
        transition: left 0.3s ease;
        overflow-y: auto;
      }
      
      .sidebar.active {
        left: 0;
      }
      
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 800;
      }
      
      .overlay.active {
        display: block;
      }
    }

    /* Улучшения доступности */
    button:focus,
    select:focus,
    input:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Анимации для плавности */
    .control-group {
      transition: transform 0.2s ease;
    }
    
    .control-group:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <button class="mobile-menu-toggle" id="menuToggle">☰</button>
  <div class="overlay" id="overlay"></div>

  <div class="app-shell">
    <!-- Левая колонка -->
    <aside class="sidebar">
      <img src="images/connect_logo-1.jpg" alt="Connect Logo" class="logo"
           onerror="this.onerror=null;this.src='images/connect_logo-1.png'">
      <div class="app-title">Screen Preview</div>
      <div class="app-subtitle">Маски, видео и изображения</div>
    </aside>

    <!-- Правая колонка -->
    <main class="main">
      <div class="interface-container">
        <header>
          <h1>Screen Preview с масштабированием</h1>
          <p class="subtitle">Просмотр контента на различных экранах с сохранением оригинальных пропорций</p>
        </header>

        <div class="main-content">
          <div class="control-panel" id="controlPanel">
            <div class="control-group">
              <h2>Экран</h2>
              <label for="screenSelect">Выберите экран:</label>
              <select id="screenSelect">
                <option value="Bolshoi">Большой экран (6528×1472)</option>
                <option value="Poloski">Экран полоски (640×1920)</option>
                <option value="Nav">Навигация (316×384)</option>
                <option value="Bar1">Бар 1 (384×64)</option>
                <option value="Bar2">Бар 2 (256×64)</option>
                <option value="Recepshen">Рецепшен (2176×1280)</option>
                <option value="TualetM">Туалет мужской (284×256)</option>
                <option value="TualetW">Туалет женский (284×256)</option>
                <option value="TualetPotolok">Туалет потолок (383×384)</option>
                <option value="Lestnitsa">Экран на лестнице (200×120)</option>
              </select>

              <label for="uploadInput">Загрузить контент:</label>
              <input type="file" id="uploadInput" accept="image/*,video/*">
              <div class="error-message" id="uploadError"></div>
            </div>

            <div class="control-group">
              <h2>Масштаб</h2>
              <label for="scaleSlider">Масштаб: <span id="scaleValue">100%</span></label>
              <input type="range" id="scaleSlider" min="5" max="600" value="100">
              <button id="autoFitBtn">Автоподгон</button>
            </div>

            <div class="control-group">
              <h2>Внешний вид</h2>
              <label for="contentOpacity">Прозрачность контента: <span id="opacityValue">100%</span></label>
              <input type="range" id="contentOpacity" min="0" max="100" value="100">
              <label for="bgColor">Цвет фона:</label>
              <input type="color" id="bgColor" value="#2c3e50">
              <div class="color-preview" id="colorPreview"></div>
            </div>
          </div>
        </div>

        <div class="row-full">
          <div class="preview-section">
            <div class="preview-container" id="previewContainer">
              <div id="screenContainer">
                <div class="loading-indicator" id="loadingIndicator">Загрузка маски экрана...</div>
                <img id="maskImage" src="" alt="Mask" onerror="handleImageError()">
                <video id="videoPlayer" controls></video>
                <canvas id="previewCanvas"></canvas>
                <div class="placeholder-message" id="placeholderMessage">
                  <h3>Загрузите контент для предпросмотра</h3>
                  <p>Выберите файл изображения или видео для отображения на выбранном экране</p>
                </div>
              </div>
            </div>

            <div class="interface-container" style="margin-top:var(--spacing-md);">
              <div class="screen-info">
                <div class="info-grid">
                  <div class="info-item">
                    <div class="info-label">Текущий экран</div>
                    <div class="info-value" id="currentScreen">Большой экран</div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Разрешение</div>
                    <div class="info-value" id="screenResolution">6528 × 1472</div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Соотношение сторон</div>
                    <div class="info-value" id="aspectRatio">102:23</div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Масштаб</div>
                    <div class="info-value" id="scalePercent">100%</div>
                  </div>
                </div>
                <div class="fullscreen-btn-container" style="text-align:center;margin-top:var(--spacing-sm);">
                  <button id="fullscreenBtn">Полный экран</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- /interface-container (верхний) -->
    </main>
  </div> <!-- /app-shell -->

  <script>
    const maskCache = {};
    const smallScreens = ['Nav','Bar1','Bar2','TualetM','TualetW','TualetPotolok','Lestnitsa'];

    // Индивидуальные масштабы по умолчанию
    const screens = {
      Bolshoi:       { w:6528, h:1472, src: 'images/Bolshoi-ekran-6528kh1472.jpg', defaultScale: 109 },
      Poloski:       { w:640,  h:1920, src: 'images/Ekran-poloski-640x1920.jpg',  defaultScale: 95  },
      Nav:           { w:316,  h:384,  src: 'images/Navigation-316x384.jpg',      defaultScale: 212 },
      Bar1:          { w:384,  h:64,   src: 'images/Bar 1 384x64.jpg',             defaultScale: 365 },
      Bar2:          { w:256,  h:64,   src: 'images/Bar-2-256Kh64.jpg',            defaultScale: 100 },
      Recepshen:     { w:2176, h:1280, src: 'images/Recepshen-2176x1280.jpg',      defaultScale: 109 },
      TualetM:       { w:284,  h:256,  src: 'images/Tualet-men-284x256.jpg',       defaultScale: 313 },
      TualetW:       { w:284,  h:256,  src: 'images/Tualet-women-284x256.jpg',     defaultScale: 100 },
      TualetPotolok: { w:383,  h:384,  src: 'images/Tualet-potolok-383x384.jpg',   defaultScale: 208 },
      Lestnitsa:     { w:200,  h:120,  src: 'images/Ekran-na-lestnice-200Kh120-1920Kh1080.jpg', defaultScale: 410 }
    };

    // Элементы DOM
    const sel = document.getElementById('screenSelect');
    const inFile = document.getElementById('uploadInput');
    const cont = document.getElementById('screenContainer');
    const maskImg = document.getElementById('maskImage');
    const vid = document.getElementById('videoPlayer');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const scaleSlider = document.getElementById('scaleSlider');
    const scaleValue = document.getElementById('scaleValue');
    const autoFitBtn = document.getElementById('autoFitBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const opacitySlider = document.getElementById('contentOpacity');
    const opacityValue = document.getElementById('opacityValue');
    const bgColorPicker = document.getElementById('bgColor');
    const colorPreview = document.getElementById('colorPreview');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const placeholderMessage = document.getElementById('placeholderMessage');
    const uploadError = document.getElementById('uploadError');
    const currentScreen = document.getElementById('currentScreen');
    const screenResolution = document.getElementById('screenResolution');
    const aspectRatio = document.getElementById('aspectRatio');
    const scalePercent = document.getElementById('scalePercent');
    const previewContainer = document.getElementById('previewContainer');
    const menuToggle = document.getElementById('menuToggle');
    const overlay = document.getElementById('overlay');
    const sidebar = document.querySelector('.sidebar');

    // Вспомогательные функции
    function gcd(a,b){ return b===0 ? a : gcd(b, a%b); }
    
    function calculateAspectRatio(width, height){
      const d = gcd(width, height);
      return `${width/d}:${height/d}`;
    }

    function applyContainerSize(scr){
      cont.style.width = scr.w + 'px';
      cont.style.height = scr.h + 'px';
    }

    function setScaleValue(percent){
      const v = Math.max(5, Math.min(600, Math.floor(percent)));
      scaleSlider.value = v;
      const s = v / 100;
      cont.style.transform = `scale(${s})`;
      scaleValue.textContent = `${v}%`;
      scalePercent.textContent = `${v}%`;
    }

    function updateScale(){
      setScaleValue(scaleSlider.value);
    }

    function autoFit(){
      const scr = screens[sel.value];
      const availW = previewContainer.clientWidth - 24;
      const availH = previewContainer.clientHeight - 24;
      const boost = smallScreens.includes(sel.value) ? 2 : 1;
      const scale = Math.min(availW / scr.w, availH / scr.h) * 100 * boost;
      setScaleValue(scale);
    }

    function updateOpacity(){
      const o = opacitySlider.value / 100;
      vid.style.opacity = o;
      canvas.style.opacity = o;
      opacityValue.textContent = `${opacitySlider.value}%`;
    }

    function updateBackground(){
      const color = bgColorPicker.value;
      document.body.style.background = `url('images/Back.jpg') no-repeat center center fixed, linear-gradient(to bottom, ${color}, ${darkenColor(color,0.3)})`;
      document.body.style.backgroundSize = 'cover';
      colorPreview.style.backgroundColor = color;
    }
    
    function darkenColor(color, amt){
      let r = parseInt(color.substring(1,3),16);
      let g = parseInt(color.substring(3,5),16);
      let b = parseInt(color.substring(5,7),16);
      r = Math.max(0, Math.floor(r*(1-amt)));
      g = Math.max(0, Math.floor(g*(1-amt)));
      b = Math.max(0, Math.floor(b*(1-amt)));
      return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
    }

    function handleImageError(){
      loadingIndicator.style.display = 'none';
      const scr = screens[sel.value];
      maskImg.style.display = 'none';
      const old = document.getElementById('fallbackCanvas');
      if (old) old.remove();

      const fb = document.createElement('canvas');
      fb.id = 'fallbackCanvas';
      fb.width = scr.w; 
      fb.height = scr.h;
      const c = fb.getContext('2d');
      c.strokeStyle = '#3498db';
      c.lineWidth = 10;
      c.strokeRect(0, 0, scr.w, scr.h);
      c.fillStyle = '#3498db';
      c.font = '80px Arial';
      c.textAlign = 'center';
      c.fillText(`Экран: ${sel.value}`, scr.w/2, scr.h/2 - 50);
      c.fillText(`${scr.w} × ${scr.h} пикселей`, scr.w/2, scr.h/2 + 50);

      fb.style.position = 'absolute';
      fb.style.inset = '0';
      fb.style.width = '100%';
      fb.style.height = '100%';
      fb.style.zIndex = '1';
      cont.appendChild(fb);
    }

    function applyDefaultScale(scrKey){
      const scr = screens[scrKey];
      if (scr && typeof scr.defaultScale === 'number') setScaleValue(scr.defaultScale);
    }

    function updateScreen(){
      const scrKey = sel.value;
      const scr = screens[scrKey];

      const old = document.getElementById('fallbackCanvas');
      if (old) old.remove();

      loadingIndicator.style.display = 'block';
      maskImg.style.display = 'block';

      applyContainerSize(scr);

      vid.style.display = 'none';
      canvas.style.display = 'none';
      inFile.value = '';

      currentScreen.textContent = sel.options[sel.selectedIndex].text;
      screenResolution.textContent = `${scr.w} × ${scr.h}`;
      aspectRatio.textContent = calculateAspectRatio(scr.w, scr.h);

      // Для всех экранов по умолчанию содержимое вписывается с сохранением пропорций
      vid.style.objectFit = 'contain';
      vid.style.objectPosition = 'center';

      // Проверяем кэш
      if (maskCache[scrKey]) {
        maskImg.src = maskCache[scrKey];
        loadingIndicator.style.display = 'none';
        applyDefaultScale(scrKey);
        return;
      }

      const url = scr.src;
      const img = new Image();
      img.onload = () => {
        maskImg.src = url;
        maskCache[scrKey] = url;
        loadingIndicator.style.display = 'none';
        applyDefaultScale(scrKey);
      };
      img.onerror = () => {
        handleImageError();
        applyDefaultScale(scrKey);
      };
      img.src = url;
    }

    // Обработчики событий
    document.getElementById('screenSelect').addEventListener('change', updateScreen);
    document.getElementById('autoFitBtn').addEventListener('click', autoFit);
    document.getElementById('scaleSlider').addEventListener('input', updateScale);
    document.getElementById('contentOpacity').addEventListener('input', updateOpacity);
    document.getElementById('bgColor').addEventListener('input', updateBackground);

    document.getElementById('fullscreenBtn')?.addEventListener('click', () => {
      if (!document.fullscreenElement){
        if (previewContainer.requestFullscreen) {
          previewContainer.requestFullscreen().catch(()=>{});
        }
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
      }
    });

    // Оптимизированный обработчик изменения размера
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Сохраняем выбранный масштаб — без автоподгона на resize
      }, 250);
    });

    // Загрузка контента
    inFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      placeholderMessage.style.display = 'none';
      uploadError.style.display = 'none';

      if (!file.type.startsWith('image/') && !file.type.startsWith('video/')){
        uploadError.textContent = 'Неподдерживаемый формат файла. Используйте изображение или видео.';
        uploadError.style.display = 'block';
        return;
      }

      const scrKey = sel.value;
      const scr = screens[scrKey];
      const cw = scr.w, ch = scr.h;

      if (file.type.startsWith('image/')){
        vid.style.display = 'none';
        canvas.style.display = 'block';
        canvas.width = cw; 
        canvas.height = ch;

        const img = new Image();
        img.onload = () => {
          const ctx2 = canvas.getContext('2d');
          ctx2.clearRect(0, 0, cw, ch);

          if (scrKey === 'Poloski'){
            // Масштаб по ширине маски, центр по вертикали (без искажения пропорций)
            const scaleW = cw / img.width;
            const w = cw;
            const h = img.height * scaleW;
            const y = (ch - h) / 2;
            ctx2.drawImage(img, 0, y, w, h);
          } else {
            // Обычное вписывание с сохранением пропорций
            const scale = Math.min(cw / img.width, ch / img.height);
            const w = img.width * scale;
            const h = img.height * scale;
            const x = (cw - w) / 2;
            const y = (ch - h) / 2;
            ctx2.drawImage(img, x, y, w, h);
          }
          
          URL.revokeObjectURL(img.src);
        };
        img.onerror = () => {
          uploadError.textContent = 'Ошибка загрузки изображения';
          uploadError.style.display = 'block';
          placeholderMessage.style.display = 'block';
        };
        img.src = URL.createObjectURL(file);
        canvas.style.opacity = opacitySlider.value / 100;
      } else {
        canvas.style.display = 'none';
        vid.style.display = 'block';

        // Для Poloski — ширина маски, сохранение пропорций: width:100% + height:auto через contain
        if (scrKey === 'Poloski') {
          vid.style.objectFit = 'contain'; // сохраняет пропорции во вьюбоксе видео
          vid.style.objectPosition = 'center';
          // гарантируем растяжение по ширине контейнера маски
          vid.style.width = '100%';
          vid.style.height = 'auto';
        } else {
          vid.style.objectFit = 'contain';
          vid.style.objectPosition = 'center';
          vid.style.width = '100%';
          vid.style.height = '100%';
        }

        vid.onerror = () => {
          uploadError.textContent = 'Ошибка загрузки видео';
          uploadError.style.display = 'block';
          placeholderMessage.style.display = 'block';
        };
        vid.src = URL.createObjectURL(file);
        vid.play().catch(()=>{});
        vid.style.opacity = opacitySlider.value / 100;
      }
    });

    // Мобильное меню
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
      document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
    });

    overlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    });

    // Закрытие меню при клике на пункт
    sidebar.addEventListener('click', (e) => {
      if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    // Инициализация
    updateScreen();
    updateBackground();
    document.getElementById('colorPreview').style.backgroundColor = bgColorPicker.value;
  </script>
</body>
</html>
