<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Screen Preview с масштабированием</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom, #2c3e50, #1a2530);
      color: #ecf0f1;
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 0.5s ease;
      overflow-x: hidden;
    }
    
    .interface-container {
      width: 100%;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 1;
      transform-origin: top center;
      transition: transform 0.3s ease;
    }
    
    header {
      text-align: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      backdrop-filter: blur(10px);
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: clamp(1.5rem, 4vw, 2.2rem);
      margin-bottom: 10px;
      color: #3498db;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      color: #bdc3c7;
    }
    
    .main-content {
      display: flex;
      gap: 20px;
      flex: 1;
      min-height: 0;
    }
    
    @media (max-width: 900px) {
      .main-content {
        flex-direction: column;
      }
    }
    
    .control-panel {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 300px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      z-index: 100;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    
    .control-panel-toggle {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 101;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .control-panel {
        width: 280px;
        left: 10px;
        top: 10px;
        max-height: 90vh;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .control-panel.active {
        transform: translateX(0);
      }
      
      .control-panel-toggle {
        display: block;
      }
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #3498db;
      font-size: clamp(0.9rem, 2vw, 1rem);
    }
    
    select, input[type="range"], button, input[type="color"] {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: clamp(0.9rem, 2vw, 1rem);
      background: #34495e;
      color: #ecf0f1;
      margin-bottom: 8px;
    }
    
    select:focus, input[type="range"]:focus {
      outline: 2px solid #3498db;
    }
    
    .file-upload {
      border: 2px dashed #7f8c8d;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      margin-bottom: 15px;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .file-upload:hover {
      border-color: #3498db;
      background: rgba(52, 152, 219, 0.1);
    }
    
    .file-input {
      display: none;
    }
    
    .scale-controls {
      background: rgba(52, 73, 94, 0.6);
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .additional-controls {
      background: rgba(52, 73, 94, 0.6);
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .scale-display {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      color: #bdc3c7;
      font-size: clamp(0.8rem, 1.5vw, 0.9rem);
    }
    
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      margin-top: 8px;
      padding: 10px;
      border-radius: 5px;
      font-size: clamp(0.9rem, 2vw, 1rem);
    }
    
    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    #autoFitBtn {
      background: #2ecc71;
    }
    
    #autoFitBtn:hover {
      background: #27ae60;
    }
    
    .preview-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 400px;
      margin-left: 320px; /* Отступ для панели управления */
    }
    
    @media (max-width: 768px) {
      .preview-section {
        margin-left: 0;
        padding-top: 50px;
      }
    }
    
    .preview-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      width: 100%;
      min-height: 300px;
    }
    
    #screenContainer {
      position: relative;
      display: inline-block;
      transform-origin: top left;
      transition: transform 0.2s ease;
      max-width: 100%;
      max-height: 100%;
      will-change: transform;
    }
    
    #maskImage {
      position: absolute; 
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%; 
      z-index: 1;
      opacity: 0.8;
    }
    
    #videoPlayer, #previewCanvas {
      position: absolute; 
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%; 
      z-index: 2;
      object-fit: contain;
    }
    
    #videoPlayer { 
      display: none; 
    }
    
    #previewCanvas { 
      display: none; 
    }
    
    .screen-info {
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      backdrop-filter: blur(10px);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: clamp(0.8rem, 1.5vw, 0.9rem);
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: 600;
      color: #3498db;
    }
    
    .info-value {
      color: #ecf0f1;
    }
    
    input[type="range"] {
      -webkit-appearance: none;
      height: 8px;
      background: #7f8c8d;
      border-radius: 4px;
      outline: none;
      width: 100%;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #3498db;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      background: #2980b9;
    }
    
    .fullscreen-toggle {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      z-index: 10;
      font-size: clamp(0.8rem, 1.5vw, 0.9rem);
      transition: all 0.3s;
    }
    
    .fullscreen-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .color-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 5px;
      border: 2px solid #fff;
      transition: background-color 0.3s ease;
    }
    
    .placeholder-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #7f8c8d;
      z-index: 0;
      width: 80%;
    }
    
    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 10px;
      display: none;
    }
    
    .loading-indicator {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      color: #3498db;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .main-content {
        gap: 15px;
      }
      
      .preview-section {
        margin-left: 310px;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .interface-container {
        gap: 15px;
      }
      
      header {
        padding: 10px;
      }
      
      .main-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .preview-section {
        min-height: 300px;
        padding-top: 0;
      }
      
      .preview-container {
        min-height: 250px;
      }
    }
    
    @media (max-width: 480px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .file-upload {
        padding: 12px;
      }
      
      .scale-controls {
        padding: 10px;
      }
      
      .additional-controls {
        padding: 10px;
      }
      
      .control-panel {
        width: 90%;
        left: 5%;
        top: 5%;
      }
    }

    /* Orientation specific styles */
    @media (max-width: 768px) and (orientation: landscape) {
      .preview-section {
        min-height: 200px;
      }
      
      .preview-container {
        min-height: 180px;
      }
    }
  </style>
</head>
<body>
  <button class="control-panel-toggle" id="panelToggle">☰ Панель управления</button>
  
  <div class="interface-container">
    <header>
      <h1>Screen Preview с масштабированием</h1>
      <p class="subtitle">Просмотр контента на различных экранах с сохранением оригинальных пропорций</p>
    </header>
    
    <div class="main-content">
      <div class="control-panel" id="controlPanel">
        <div class="form-group">
          <label for="screenSelect">Выберите экран:</label>
          <select id="screenSelect">
            <option value="Bolshoi">Bolshoi 6528×1472</option>
            <option value="Poloski">Poloski 640×1920</option>
            <option value="Nav">Navigation 316×384</option>
            <option value="Bar1">Bar 1 384×64</option>
            <option value="Bar2">Bar 2 256×64</option>
            <option value="Recepshen">Recepshen 2176×1280</option>
            <option value="TualetM">Tualet Men 284×256</option>
            <option value="TualetW">Tualet Women 284×256</option>
            <option value="TualetPotolok">Tualet Potolok 383×384</option>
            <option value="Lestnitsa">Lestnitsa 200×120 → 1920×1080</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Загрузите контент:</label>
          <div class="file-upload" onclick="document.getElementById('uploadInput').click()">
            <p>Нажмите для загрузки файла</p>
            <p><small>(Поддерживаются изображения и видео)</small></p>
            <input type="file" id="uploadInput" class="file-input" accept="image/*,video/*" />
          </div>
          <p class="error-message" id="uploadError"></p>
        </div>
        
        <div class="scale-controls">
          <div class="form-group">
            <label for="scaleSlider">Масштаб: <span id="scaleValue">100%</span></label>
            <input type="range" id="scaleSlider" min="10" max="400" value="100">
            <div class="scale-display">
              <span>10%</span>
              <span>400%</span>
            </div>
          </div>
          
          <button id="autoFitBtn">Автоподгонка</button>
          <button id="fullscreenBtn" class="fullscreen-toggle">Полный экран</button>
        </div>
        
        <div class="additional-controls">
          <div class="form-group">
            <label for="contentOpacity">Прозрачность контента: <span id="opacityValue">100%</span></label>
            <input type="range" id="contentOpacity" min="0" max="100" value="100">
            <div class="scale-display">
              <span>0%</span>
              <span>100%</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="bgColor">Цвет фона интерфейса:</label>
            <div class="color-control">
              <input type="color" id="bgColor" value="#2c3e50">
              <div class="color-preview" id="colorPreview"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="preview-section">
        <div class="preview-container">
          <div id="screenContainer">
            <div class="loading-indicator" id="loadingIndicator">Загрузка маски экрана...</div>
            <img id="maskImage" src="" alt="Mask" onerror="handleImageError()">
            <video id="videoPlayer" controls></video>
            <canvas id="previewCanvas"></canvas>
            <div class="placeholder-message" id="placeholderMessage">
              <h3>Загрузите контент для предпросмотра</h3>
              <p>Выберите файл изображения или видео для отображения на выбранном экране</p>
            </div>
          </div>
        </div>
        
        <div class="screen-info">
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Текущий экран:</span>
              <span id="currentScreen" class="info-value">Bolshoi</span>
            </div>
            <div class="info-item">
              <span class="info-label">Оригинальное разрешение:</span>
              <span id="screenResolution" class="info-value">6528 × 1472</span>
            </div>
            <div class="info-item">
              <span class="info-label">Соотношение сторон:</span>
              <span id="aspectRatio" class="info-value">4.43:1</span>
            </div>
            <div class="info-item">
              <span class="info-label">Масштаб:</span>
              <span id="scalePercent" class="info-value">100%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Автоматическое определение базового URL для GitHub Pages
    const isGitHubPages = window.location.hostname.includes('github.io');
    const repoName = window.location.pathname.split('/')[1] || 'screen-preview'; // Имя репозитория
    const baseUrl = isGitHubPages 
        ? `${window.location.origin}${window.location.pathname.split('/').slice(0, 2).join('/')}`
        : '';

    // Кэш для уже загруженных масок
    const maskCache = {};
    
    // Определяем мелкие экраны, которые нужно увеличивать в 2 раза
    const smallScreens = ['Nav', 'Bar1', 'Bar2', 'TualetM', 'TualetW', 'TualetPotolok', 'Lestnitsa'];

    const screens = {
      Bolshoi:       { w:6528, h:1472, src: `${baseUrl}/images/Bolshoi-ekran-6528kh1472.jpg` },
      Poloski:       { w:640,  h:1920, src: `${baseUrl}/images/Ekran-poloski-640x1920.jpg` },
      Nav:           { w:316,  h:384,  src: `${baseUrl}/images/Navigation-316x384.jpg` },
      Bar1:          { w:384,  h:64,   src: `${baseUrl}/images/Bar 1 384x64.jpg` },
      Bar2:          { w:256,  h:64,   src: `${baseUrl}/images/Bar-2-256Kh64.jpg` },
      Recepshen:     { w:2176, h:1280, src: `${baseUrl}/images/Recepshen-2176x1280.jpg` },
      TualetM:       { w:284,  h:256,  src: `${baseUrl}/images/Tualet-men-284x256.jpg` },
      TualetW:       { w:284,  h:256,  src: `${baseUrl}/images/Tualet-women-284x256.jpg` },
      TualetPotolok: { w:383,  h:384,  src: `${baseUrl}/images/Tualet-potolok-383x384.jpg` },
      Lestnitsa:     { w:200,  h:120,  src: `${baseUrl}/images/Ekran-na-lestnice-200Kh120-1920Kh1080.jpg`, fitW:1920, fitH:1080 }
    };

    console.log("Base URL:", baseUrl);
    console.log("Screen paths:", screens);

    const sel = document.getElementById('screenSelect');
    const inFile = document.getElementById('uploadInput');
    const cont = document.getElementById('screenContainer');
    const maskImg = document.getElementById('maskImage');
    const vid = document.getElementById('videoPlayer');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const scaleSlider = document.getElementById('scaleSlider');
    const scaleValue = document.getElementById('scaleValue');
    const autoFitBtn = document.getElementById('autoFitBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const opacitySlider = document.getElementById('contentOpacity');
    const opacityValue = document.getElementById('opacityValue');
    const bgColorPicker = document.getElementById('bgColor');
    const colorPreview = document.getElementById('colorPreview');
    const interfaceContainer = document.querySelector('.interface-container');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const placeholderMessage = document.getElementById('placeholderMessage');
    const uploadError = document.getElementById('uploadError');
    const panelToggle = document.getElementById('panelToggle');
    const controlPanel = document.getElementById('controlPanel');
    
    // Info panel elements
    const currentScreen = document.getElementById('currentScreen');
    const screenResolution = document.getElementById('screenResolution');
    const aspectRatio = document.getElementById('aspectRatio');
    const scalePercent = document.getElementById('scalePercent');

    // Переменная для отслеживания ориентации устройства
    let isPortrait = window.innerHeight > window.innerWidth;
    let resizeTimeout;

    // Toggle control panel on mobile
    panelToggle.addEventListener('click', function() {
      controlPanel.classList.toggle('active');
    });

    // Close panel when clicking outside on mobile
    document.addEventListener('click', function(e) {
      if (window.innerWidth <= 768 && 
          !controlPanel.contains(e.target) && 
          e.target !== panelToggle &&
          controlPanel.classList.contains('active')) {
        controlPanel.classList.remove('active');
      }
    });

    // Calculate aspect ratio
    function calculateAspectRatio(width, height) {
      // Function to find greatest common divisor
      function gcd(a, b) {
        return b === 0 ? a : gcd(b, a % b);
      }
      
      const divisor = gcd(width, height);
      const ratioW = width / divisor;
      const ratioH = height / divisor;
      
      // For very large ratios, approximate to one decimal place
      if (ratioW > 10 || ratioH > 10) {
        return (width / height).toFixed(2) + ':1';
      }
      
      return `${ratioW}:${ratioH}`;
    }

    function updateScale() {
      const s = scaleSlider.value / 100;
      cont.style.transform = `scale(${s})`;
      scaleValue.textContent = `${scaleSlider.value}%`;
      scalePercent.textContent = `${scaleSlider.value}%`;
    }

    function updateOpacity() {
      const opacity = opacitySlider.value / 100;
      if (vid.style.display !== 'none') {
        vid.style.opacity = opacity;
      }
      if (canvas.style.display !== 'none') {
        canvas.style.opacity = opacity;
      }
      opacityValue.textContent = `${opacitySlider.value}%`;
    }

    function updateBackground() {
      const color = bgColorPicker.value;
      document.body.style.background = `linear-gradient(to bottom, ${color}, ${darkenColor(color, 0.3)})`;
      colorPreview.style.backgroundColor = color;
    }

    function darkenColor(color, amount) {
      // Convert hex to RGB
      let r = parseInt(color.substring(1, 3), 16);
      let g = parseInt(color.substring(3, 5), 16);
      let b = parseInt(color.substring(5, 7), 16);

      // Darken the color
      r = Math.max(0, Math.floor(r * (1 - amount)));
      g = Math.max(0, Math.floor(g * (1 - amount)));
      b = Math.max(0, Math.floor(b * (1 - amount)));

      // Convert back to hex
      return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }

    function autoFit() {
      const scr = screens[sel.value];
      const refW = scr.fitW || scr.w;
      const refH = scr.fitH || scr.h;
      
      // Calculate available space considering the control panel
      const controlPanelWidth = window.innerWidth <= 768 ? 0 : 320;
      
      const availW = window.innerWidth - controlPanelWidth - 40; // account for margins
      const availH = window.innerHeight - 250; // account for header and other elements
      
      // Для мелких экранов увеличиваем базовый масштаб в 2 раза
      let baseScale = 1;
      if (smallScreens.includes(sel.value)) {
        baseScale = 2;
      }
      
      // For Lestnitsa, use a different scaling approach to make it more visible
      let scale;
      if (sel.value === 'Lestnitsa') {
        // For Lestnitsa, we want to make it more visible despite its small original size
        scale = Math.min(availW / refW, availH / refH, 2) * 100 * baseScale;
      } else {
        scale = Math.min(availW / refW, availH / refH, 1) * 100 * baseScale;
      }
      
      scaleSlider.value = Math.max(10, Math.min(400, Math.floor(scale)));
      updateScale();
    }

    // Функция для масштабирования маски под высоту окна браузера
    function scaleMaskToWindow() {
      const scr = screens[sel.value];
      const screenHeight = scr.fitH || scr.h;
      const screenWidth = scr.fitW || scr.w;
      
      // Определяем доступную высоту области просмотра
      const previewContainer = document.querySelector('.preview-container');
      const availableHeight = previewContainer.clientHeight;
      const availableWidth = previewContainer.clientWidth;
      
      // Вычисляем масштаб на основе высоты экрана и доступного пространства
      let maskScale = Math.min(availableWidth / screenWidth, availableHeight / screenHeight);
      
      // Для мелких экранов увеличиваем базовый масштаб в 2 раза
      if (smallScreens.includes(sel.value)) {
        maskScale *= 2;
      }
      
      // Ограничиваем масштаб для мобильных устройств
      if (window.innerWidth <= 768) {
        maskScale = Math.min(maskScale, 1);
      }
      
      // Применяем масштабирование к контейнеру маски
      cont.style.transform = `scale(${maskScale})`;
      
      // Обновляем значение в слайдере
      scaleSlider.value = Math.max(10, Math.min(400, Math.floor(maskScale * 100)));
      scaleValue.textContent = `${scaleSlider.value}%`;
      scalePercent.textContent = `${scaleSlider.value}%`;
    }

    function handleImageError() {
      console.error("Ошибка загрузки изображения маски экрана:", maskImg.src);
      loadingIndicator.style.display = 'none';
      
      // Создаем fallback - простой контур экрана
      const scr = screens[sel.value];
      const cw = scr.fitW || scr.w;
      const ch = scr.fitH || scr.h;
      
      // Создаем canvas с контуром экрана
      const fallbackCanvas = document.createElement('canvas');
      fallbackCanvas.width = cw;
      fallbackCanvas.height = ch;
      const fallbackCtx = fallbackCanvas.getContext('2d');
      
      // Рисуем контур экрана
      fallbackCtx.strokeStyle = '#3498db';
      fallbackCtx.lineWidth = 2;
      fallbackCtx.strokeRect(0, 0, cw, ch);
      
      // Добавляем текст с информацией
      fallbackCtx.fillStyle = '#3498db';
      fallbackCtx.font = '16px Arial';
      fallbackCtx.textAlign = 'center';
      fallbackCtx.fillText(`Экран: ${sel.value}`, cw/2, ch/2 - 10);
      fallbackCtx.fillText(`${cw} × ${ch} пикселей`, cw/2, ch/2 + 10);
      
      // Заменяем изображение на canvas
      maskImg.style.display = 'none';
      fallbackCanvas.style.position = 'absolute';
      fallbackCanvas.style.top = '0';
      fallbackCanvas.style.left = '0';
      fallbackCanvas.style.width = '100%';
      fallbackCanvas.style.height = '100%';
      fallbackCanvas.style.zIndex = '1';
      fallbackCanvas.id = 'fallbackCanvas';
      cont.appendChild(fallbackCanvas);
    }

    function updateScreen(){
      const scr = screens[sel.value];
      
      // Удаляем fallback canvas, если он есть
      const fallbackCanvas = document.getElementById('fallbackCanvas');
      if (fallbackCanvas) {
        fallbackCanvas.remove();
      }
      
      // Показываем индикатор загрузки
      loadingIndicator.style.display = 'block';
      maskImg.style.display = 'block';
      
      // Проверяем, есть ли изображение в кэше
      if (maskCache[sel.value]) {
        // Используем кэшированное изображение
        maskImg.src = maskCache[sel.value];
        loadingIndicator.style.display = 'none';
      } else {
        // Пытаемся загрузить изображение
        const testImage = new Image();
        testImage.onload = function() {
          maskImg.src = scr.src;
          maskCache[sel.value] = scr.src;
          loadingIndicator.style.display = 'none';
        };
        
        testImage.onerror = function() {
          console.error("Не удалось загрузить маску:", scr.src);
          handleImageError();
        };
        
        testImage.src = scr.src;
      }
      
      // Use original screen dimensions
      const cw = scr.fitW || scr.w;
      const ch = scr.fitH || scr.h;
      
      cont.style.width = cw + 'px';
      cont.style.height = ch + 'px';
      
      vid.style.display = 'none';
      canvas.style.display = 'none';
      inFile.value = '';
      
      // Update info panel
      currentScreen.textContent = sel.options[sel.selectedIndex].text;
      screenResolution.textContent = `${scr.w} × ${scr.h}`;
      aspectRatio.textContent = calculateAspectRatio(scr.w, scr.h);
      
      // Масштабируем маску под высоту окна браузера
      scaleMaskToWindow();
      
      setTimeout(autoFit, 50);
    }

    // Fullscreen functionality
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error(`Error attempting to enable full-screen mode: ${err.message}`);
        });
        fullscreenBtn.textContent = 'Выйти из полноэкранного режима';
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
          fullscreenBtn.textContent = 'Полный экран';
        }
      }
    }

    // Event listeners
    sel.addEventListener('change', updateScreen);
    scaleSlider.addEventListener('input', updateScale);
    autoFitBtn.addEventListener('click', autoFit);
    opacitySlider.addEventListener('input', updateOpacity);
    bgColorPicker.addEventListener('input', updateBackground);
    
    // Оптимизированная обработка ресайза
    window.addEventListener('resize', function() {
      // Проверяем изменение ориентации
      const newIsPortrait = window.innerHeight > window.innerWidth;
      if (newIsPortrait !== isPortrait) {
        isPortrait = newIsPortrait;
        // При изменении ориентации полностью перезагружаем экран
        updateScreen();
      } else {
        // При обычном ресайзе используем debounce
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          if (scaleSlider.value == 100) autoFit();
          scaleMaskToWindow();
        }, 250);
      }
    });

    inFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Скрываем сообщение-заполнитель
      placeholderMessage.style.display = 'none';
      uploadError.style.display = 'none';
      
      // Проверяем тип файла
      if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
        uploadError.textContent = 'Неподдерживаемый формат файла. Используйте изображение или видео.';
        uploadError.style.display = 'block';
        return;
      }
      
      const scr = screens[sel.value];
      const cw = scr.fitW || scr.w;
      const ch = scr.fitH || scr.h;
      
      if (file.type.startsWith('image/')) {
        vid.style.display = 'none';
        canvas.style.display = 'block';
        canvas.width = cw;
        canvas.height = ch;
        const img = new Image();
        img.onload = () => {
          ctx.clearRect(0, 0, cw, ch);
          const sc = Math.min(cw / img.width, ch / img.height);
          const w = img.width * sc;
          const h = img.height * sc;
          ctx.drawImage(img, (cw - w) / 2, (ch - h) / 2, w, h);
        };
        img.onerror = () => {
          uploadError.textContent = 'Ошибка загрузки изображения';
          uploadError.style.display = 'block';
          placeholderMessage.style.display = 'block';
        };
        img.src = URL.createObjectURL(file);
        // Apply current opacity
        setTimeout(() => {
          canvas.style.opacity = opacitySlider.value / 100;
        }, 100);
      } else if (file.type.startsWith('video/')) {
        canvas.style.display = 'none';
        vid.style.display = 'block';
        vid.width = cw;
        vid.height = ch;
        vid.onerror = () => {
          uploadError.textContent = 'Ошибка загрузки видео';
          uploadError.style.display = 'block';
          placeholderMessage.style.display = 'block';
        };
        vid.src = URL.createObjectURL(file);
        vid.play();
        // Apply current opacity
        vid.style.opacity = opacitySlider.value / 100;
      }
    });

    // Initialize
    updateScreen();
    updateScale();
    updateBackground();
    
    // Set color preview
    colorPreview.style.backgroundColor = bgColorPicker.value;
    
    // Adjust layout on load
    window.addEventListener('load', function() {
      autoFit();
      scaleMaskToWindow();
    });

    // Добавляем обработчик изменения ориентации
    window.addEventListener('orientationchange', function() {
      // Даем время на завершение анимации поворота
      setTimeout(function() {
        updateScreen();
      }, 500);
    });
  </script>
</body>
</html>

