<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Screen Preview с масштабированием</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('images/Back.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #ecf0f1;
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      position: relative;
    }
    body::before { content: ''; position: absolute; inset: 0; background: rgba(44,62,80,0.85); z-index: -1; }

    .logo-container { text-align: center; margin-bottom: 15px; }
    .logo { max-width: 200px; height: auto; margin-bottom: 10px; }

    .interface-container {
      max-width: 1800px; /* Увеличена максимальная ширина */
      margin: 0 auto; 
      background: rgba(44,62,80,0.7);
      border-radius: 15px; 
      padding: 20px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    h1 { font-size: 2.2rem; margin-bottom: 8px; color: #3498db; }
    .subtitle { font-size: 1.1rem; opacity: 0.8; }

    .main-content { 
      display: flex; 
      gap: 25px; 
      flex-wrap: wrap; 
    }

    .control-panel {
      flex: 0 0 300px; 
      background: rgba(52,73,94,0.8); 
      padding: 20px; 
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .control-group { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .control-group:last-child { border-bottom: none; }
    h2 { font-size: 1.3rem; margin-bottom: 15px; color: #3498db; }
    label { display: block; margin-bottom: 8px; font-weight: 500; }

    select, input[type="file"], input[type="range"], input[type="color"] {
      width: 100%; padding: 10px; margin-bottom: 15px; border: none; border-radius: 5px;
      background: #2c3e50; color: #ecf0f1; font-size: 1rem;
    }
    input[type="range"] { padding: 0; height: 8px; -webkit-appearance: none; background: #34495e; border-radius: 4px; }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3498db; cursor: pointer;
    }
    button {
      width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 5px;
      font-size: 1rem; cursor: pointer; transition: background 0.3s; margin-bottom: 10px;
    }
    button:hover { background: #2980b9; }

    .color-preview { width: 30px; height: 30px; border-radius: 5px; border: 2px solid #ecf0f1; margin-top: 5px; }

    .preview-section { 
      flex: 1; 
      min-width: 300px; 
    }
    .preview-container {
      position: relative; 
      width: 100%; 
      height: 70vh; /* Увеличена высота контейнера */
      min-height: 450px; /* Увеличена минимальная высота */
      background: rgba(0,0,0,0.3);
      border-radius: 10px; 
      overflow: auto; /* Добавлена прокрутка если нужно */
      display: flex; 
      justify-content: center; 
      align-items: center;
      margin-bottom: 15px; 
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    #screenContainer {
      position: relative; 
      transform-origin: center center; 
      transition: transform 0.2s ease;
      max-width: 100%; /* Ограничение максимальной ширины */
      max-height: 100%; /* Ограничение максимальной высоты */
    }

    /* Порядок слоёв: маска под контентом, чтобы контент был виден */
    #maskImage, #fallbackCanvas { 
      position: absolute; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 1; 
      pointer-events: none; 
      object-fit: contain; /* Добавлено для правильного отображения */
    }
    #videoPlayer { 
      position: absolute; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      z-index: 2; 
    }
    #previewCanvas { 
      position: absolute; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 2; 
    }

    .loading-indicator {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.7); 
      color: white; 
      padding: 15px 25px; 
      border-radius: 8px; 
      z-index: 5; 
      display: none;
    }
    .placeholder-message {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%);
      text-align: center; 
      color: rgba(255,255,255,0.6); 
      z-index: 0;
    }

    .screen-info {
      background: rgba(52,73,94,0.8); 
      padding: 15px; 
      border-radius: 10px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
      margin-bottom: 15px;
    }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .info-item { background: rgba(44,62,80,0.5); padding: 10px; border-radius: 8px; }
    .info-label { font-size: 0.9rem; opacity: 0.7; margin-bottom: 5px; }
    .info-value { font-size: 1rem; font-weight: 500; }

    .error-message { color: #e74c3c; margin-top: 10px; display: none; }

    .control-panel-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1000; width: auto; padding: 10px 15px; background: #3498db; border-radius: 5px; }
    .fullscreen-btn-container { text-align: center; margin-top: 10px; }
    #fullscreenBtn { width: auto; padding: 8px 15px; font-size: 0.9rem; }

    @media (max-width: 1024px) {
      .interface-container {
        max-width: 95%;
      }
      .preview-container {
        height: 60vh;
      }
    }

    @media (max-width: 768px) {
      .main-content { flex-direction: column; }
      .control-panel { 
        position: fixed; 
        top: 0; 
        left: -100%; 
        width: 80%; 
        max-width: 300px; 
        height: 100vh; 
        z-index: 999; 
        overflow-y: auto; 
        transition: left 0.3s ease; 
      }
      .control-panel.active { left: 0; }
      .control-panel-toggle { display: block; }
      .preview-container { height: 50vh; }
      .logo { max-width: 150px; }
    }
  </style>
</head>
<body>
  <button class="control-panel-toggle" id="panelToggle">☰ Панель управления</button>

  <div class="interface-container">
    <div class="logo-container">
      <img src="images/connect_logo-1.jpg" alt="Connect Logo" class="logo"
           onerror="this.onerror=null;this.src='images/connect_logo-1.png'">
    </div>

    <header>
      <h1>Screen Preview с масштабированием</h1>
      <p class="subtitle">Просмотр контента на различных экранах с сохранением оригинальных пропорций</p>
    </header>

    <div class="main-content">
      <div class="control-panel" id="controlPanel">
        <div class="control-group">
          <h2>Экран</h2>
          <label for="screenSelect">Выберите экран:</label>
          <select id="screenSelect">
            <option value="Bolshoi">Большой экран (6528×1472)</option>
            <option value="Poloski">Экран полоски (640×1920)</option>
            <option value="Nav">Навигация (316×384)</option>
            <option value="Bar1">Бар 1 (384×64)</option>
            <option value="Bar2">Бар 2 (256×64)</option>
            <option value="Recepshen">Рецепшен (2176×1280)</option>
            <option value="TualetM">Туалет мужской (284×256)</option>
            <option value="TualetW">Туалет женский (284×256)</option>
            <option value="TualetPotolok">Туалет потолок (383×384)</option>
            <option value="Lestnitsa">Экран на лестнице (200×120)</option>
          </select>

          <label for="uploadInput">Загрузить контент:</label>
          <input type="file" id="uploadInput" accept="image/*,video/*">
          <div class="error-message" id="uploadError"></div>
        </div>

        <div class="control-group">
          <h2>Масштаб</h2>
          <label for="scaleSlider">Масштаб: <span id="scaleValue">100%</span></label>
          <input type="range" id="scaleSlider" min="10" max="400" value="100">
          <button id="autoFitBtn">Автоподгон</button>
        </div>

        <div class="control-group">
          <h2>Внешний вид</h2>
          <label for="contentOpacity">Прозрачность контента: <span id="opacityValue">100%</span></label>
          <input type="range" id="contentOpacity" min="0" max="100" value="100">
          <label for="bgColor">Цвет фона:</label>
          <input type="color" id="bgColor" value="#2c3e50">
          <div class="color-preview" id="colorPreview"></div>
        </div>
      </div>

      <div class="preview-section">
        <div class="preview-container" id="previewContainer">
          <div id="screenContainer">
            <div class="loading-indicator" id="loadingIndicator">Загрузка маски экрана...</div>
            <img id="maskImage" src="" alt="Mask" onerror="handleImageError()" style="object-fit: contain;">
            <video id="videoPlayer" controls></video>
            <canvas id="previewCanvas"></canvas>
            <div class="placeholder-message" id="placeholderMessage">
              <h3>Загрузите контент для предпросмотра</h3>
              <p>Выберите файл изображения или видео для отображения на выбранном экране</p>
            </div>
          </div>
        </div>

        <div class="screen-info">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Текущий экран</div>
              <div class="info-value" id="currentScreen">Большой экран</div>
            </div>
            <div class="info-item">
              <div class="info-label">Разрешение</div>
              <div class="info-value" id="screenResolution">6528 × 1472</div>
            </div>
            <div class="info-item">
              <div class="info-label">Соотношение сторон</div>
              <div class="info-value" id="aspectRatio">102:23</div>
            </div>
            <div class="info-item">
              <div class="info-label">Масштаб</div>
              <div class="info-value" id="scalePercent">100%</div>
            </div>
          </div>
        </div>

        <div class="fullscreen-btn-container">
          <button id="fullscreenBtn">Полный экран</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // База: локальные относительные пути к папке images
    const maskCache = {};
    const smallScreens = ['Nav','Bar1','Bar2','TualetM','TualetW','TualetPotolok','Lestnitsa'];

    const screens = {
      Bolshoi:       { w:6528, h:1472, src: 'images/Bolshoi-ekran-6528kh1472.jpg', ratio: "102:23" },
      Poloski:       { w:640,  h:1920, src: 'images/Ekran-poloski-640x1920.jpg', ratio: "1:3" },
      Nav:           { w:316,  h:384,  src: 'images/Navigation-316x384.jpg', ratio: "79:96" },
      Bar1:          { w:384,  h:64,   src: 'images/Bar 1 384x64.jpg', ratio: "6:1" },
      Bar2:          { w:256,  h:64,   src: 'images/Bar-2-256Kh64.jpg', ratio: "4:1" },
      Recepshen:     { w:2176, h:1280, src: 'images/Recepshen-2176x1280.jpg', ratio: "17:10" },
      TualetM:       { w:284,  h:256,  src: 'images/Tualet-men-284x256.jpg', ratio: "71:64" },
      TualetW:       { w:284,  h:256,  src: 'images/Tualet-women-284x256.jpg', ratio: "71:64" },
      TualetPotolok: { w:383,  h:384,  src: 'images/Tualet-potolok-383x384.jpg', ratio: "383:384" },
      Lestnitsa:     { w:200,  h:120,  src: 'images/Ekran-na-lestnice-200Kh120-1920Kh1080.jpg', ratio: "5:3" }
    };

    const sel = document.getElementById('screenSelect');
    const inFile = document.getElementById('uploadInput');
    const cont = document.getElementById('screenContainer');
    const maskImg = document.getElementById('maskImage');
    const vid = document.getElementById('videoPlayer');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const scaleSlider = document.getElementById('scaleSlider');
    const scaleValue = document.getElementById('scaleValue');
    const autoFitBtn = document.getElementById('autoFitBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const opacitySlider = document.getElementById('contentOpacity');
    const opacityValue = document.getElementById('opacityValue');
    const bgColorPicker = document.getElementById('bgColor');
    const colorPreview = document.getElementById('colorPreview');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const placeholderMessage = document.getElementById('placeholderMessage');
    const uploadError = document.getElementById('uploadError');
    const panelToggle = document.getElementById('panelToggle');
    const controlPanel = document.getElementById('controlPanel');
    const currentScreen = document.getElementById('currentScreen');
    const screenResolution = document.getElementById('screenResolution');
    const aspectRatio = document.getElementById('aspectRatio');
    const scalePercent = document.getElementById('scalePercent');
    const previewContainer = document.getElementById('previewContainer');

    let isPortrait = window.innerHeight > window.innerWidth;
    let resizeTimeout;
    let currentScreenType = sel.value;

    panelToggle.addEventListener('click', () => controlPanel.classList.toggle('active'));
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 768 &&
          !controlPanel.contains(e.target) &&
          e.target !== panelToggle &&
          controlPanel.classList.contains('active')) {
        controlPanel.classList.remove('active');
      }
    });

    function gcd(a,b){ return b===0 ? a : gcd(b, a%b); }
    function calculateAspectRatio(width, height){
      const d = gcd(width, height);
      const rw = width/d, rh = height/d;
      return `${rw}:${rh}`;
    }

    function applyContainerSize(scr){
      // Для больших экранов устанавливаем максимальные размеры
      if (scr.w > 2000 || scr.h > 2000) {
        const maxWidth = previewContainer.clientWidth * 0.9;
        const maxHeight = previewContainer.clientHeight * 0.9;
        const scale = Math.min(maxWidth / scr.w, maxHeight / scr.h);
        
        cont.style.width = (scr.w * scale) + 'px';
        cont.style.height = (scr.h * scale) + 'px';
      } else {
        cont.style.width = scr.w + 'px';
        cont.style.height = scr.h + 'px';
      }
    }

    function updateScale(){
      const s = scaleSlider.value / 100;
      cont.style.transform = `scale(${s})`;
      scaleValue.textContent = `${scaleSlider.value}%`;
      scalePercent.textContent = `${scaleSlider.value}%`;
    }

    function autoFit(){
      const scr = screens[sel.value];
      const availW = previewContainer.clientWidth - 40;
      const availH = previewContainer.clientHeight - 40;
      
      let baseScale = smallScreens.includes(sel.value) ? 2 : 1;
      
      // Для больших экранов используем более агрессивное масштабирование
      if (scr.w > 2000 || scr.h > 2000) {
        baseScale = 0.8;
      }
      
      const scale = Math.min(availW / scr.w, availH / scr.h) * 100 * baseScale;
      scaleSlider.value = Math.max(10, Math.min(400, Math.floor(scale)));
      updateScale();
    }

    function updateOpacity(){
      const o = opacitySlider.value / 100;
      vid.style.opacity = o;
      canvas.style.opacity = o;
      opacityValue.textContent = `${opacitySlider.value}%`;
    }

    function updateBackground(){
      const color = bgColorPicker.value;
      document.body.style.background = `url('images/Back.jpg') no-repeat center center fixed, linear-gradient(to bottom, ${color}, ${darkenColor(color,0.3)})`;
      document.body.style.backgroundSize = 'cover';
      colorPreview.style.backgroundColor = color;
    }
    function darkenColor(color, amt){
      let r = parseInt(color.substring(1,3),16);
      let g = parseInt(color.substring(3,5),16);
      let b = parseInt(color.substring(5,7),16);
      r = Math.max(0, Math.floor(r*(1-amt)));
      g = Math.max(0, Math.floor(g*(1-amt)));
      b = Math.max(0, Math.floor(b*(1-amt)));
      return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
    }

    function handleImageError(){
      loadingIndicator.style.display = 'none';
      const scr = screens[sel.value];
      maskImg.style.display = 'none';
      let fb = document.getElementById('fallbackCanvas');
      if (fb) fb.remove();

      const fallbackCanvas = document.createElement('canvas');
      fallbackCanvas.width = scr.w;
      fallbackCanvas.height = scr.h;
      const fctx = fallbackCanvas.getContext('2d');
      fctx.strokeStyle = '#3498db';
      fctx.lineWidth = 2;
      fctx.strokeRect(0, 0, scr.w, scr.h);
      fctx.fillStyle = '#3498db';
      fctx.font = '16px Arial';
      fctx.textAlign = 'center';
      fctx.fillText(`Экран: ${sel.value}`, scr.w/2, scr.h/2 - 10);
      fctx.fillText(`${scr.w} × ${scr.h} пикселей`, scr.w/2, scr.h/2 + 10);
      fctx.fillText(`Соотношение: ${scr.ratio}`, scr.w/2, scr.h/2 + 30);

      fallbackCanvas.style.position = 'absolute';
      fallbackCanvas.style.inset = '0';
      fallbackCanvas.style.width = '100%';
      fallbackCanvas.style.height = '100%';
      fallbackCanvas.style.zIndex = '1';
      fallbackCanvas.id = 'fallbackCanvas';
      cont.appendChild(fallbackCanvas);
    }

    function updateScreen(){
      const scr = screens[sel.value];
      currentScreenType = sel.value;

      const fb = document.getElementById('fallbackCanvas');
      if (fb) fb.remove();

      loadingIndicator.style.display = 'block';
      maskImg.style.display = 'block';

      applyContainerSize(scr);

      vid.style.display = 'none';
      canvas.style.display = 'none';
      inFile.value = '';

      currentScreen.textContent = sel.options[sel.selectedIndex].text;
      screenResolution.textContent = `${scr.w} × ${scr.h}`;
      aspectRatio.textContent = scr.ratio;

      if (maskCache[sel.value]){
        maskImg.src = maskCache[sel.value];
        loadingIndicator.style.display = 'none';
        autoFit();
      } else {
        const testImage = new Image();
        testImage.onload = function(){
          if (sel.value === currentScreenType){
            maskImg.src = scr.src;
            maskCache[sel.value] = scr.src;
            loadingIndicator.style.display = 'none';
            autoFit();
          }
        };
        testImage.onerror = function(){
          if (sel.value === currentScreenType){
            handleImageError();
            autoFit();
          }
        };
        testImage.src = scr.src;
      }
    }

    fullscreenBtn.addEventListener('click', toggleFullscreen);
    function toggleFullscreen(){
      if (!document.fullscreenElement){
        previewContainer.requestFullscreen().catch(()=>{});
        fullscreenBtn.textContent = 'Выйти из полноэкранного режима';
      } else {
        if (document.exitFullscreen){
          document.exitFullscreen();
          fullscreenBtn.textContent = 'Полный экран';
        }
      }
    }

    sel.addEventListener('change', updateScreen);
    scaleSlider.addEventListener('input', updateScale);
    autoFitBtn.addEventListener('click', autoFit);
    opacitySlider.addEventListener('input', updateOpacity);
    bgColorPicker.addEventListener('input', updateBackground);

    window.addEventListener('resize', function(){
      const newIsPortrait = window.innerHeight > window.innerWidth;
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function(){
        if (newIsPortrait !== isPortrait){
          isPortrait = newIsPortrait;
          updateScreen();
        } else {
          autoFit();
        }
      }, 200);
    });

    window.addEventListener('orientationchange', function(){
      setTimeout(function(){
        isPortrait = window.innerHeight > window.innerWidth;
        updateScreen();
      }, 300);
    });

    // Масштабирование изображения в canvas по принципу "contain" с центрированием
    inFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      placeholderMessage.style.display = 'none';
      uploadError.style.display = 'none';

      if (!file.type.startsWith('image/') && !file.type.startsWith('video/')){
        uploadError.textContent = 'Неподдерживаемый формат файла. Используйте изображение или видео.';
        uploadError.style.display = 'block';
        return;
      }

      const scr = screens[sel.value];
      const cw = scr.w, ch = scr.h;

      if (file.type.startsWith('image/')){
        vid.style.display = 'none';
        canvas.style.display = 'block';
        canvas.width = cw;
        canvas.height = ch;

        const img = new Image();
        img.onload = () => {
          ctx.clearRect(0, 0, cw, ch);
          // contain
          const scale = Math.min(cw / img.width, ch / img.height);
          const w = img.width * scale;
          const h = img.height * scale;
          const x = (cw - w) / 2;
          const y = (ch - h) / 2;
          ctx.drawImage(img, x, y, w, h);
        };
        img.onerror = () => {
          uploadError.textContent = 'Ошибка загрузки изображения';
          uploadError.style.display = 'block';
          placeholderMessage.style.display = 'block';
        };
        img.src = URL.createObjectURL(file);
        canvas.style.opacity = opacitySlider.value / 100;
      } else {
        canvas.style.display = 'none';
        vid.style.display = 'block';
        // Видео заполняет через CSS object-fit: contain и центрируется
        vid.onerror = () => {
          uploadError.textContent = 'Ошибка загрузки видео';
          uploadError.style.display = 'block';
          placeholderMessage.style.display = 'block';
        };
        vid.src = URL.createObjectURL(file);
        vid.play().catch(()=>{});
        vid.style.opacity = opacitySlider.value / 100;
      }
    });

    // Init
    updateScreen();
    updateScale();
    updateBackground();
    document.getElementById('colorPreview').style.backgroundColor = bgColorPicker.value;
  </script>
</body>
</html>
