<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Screen Preview с масштабированием</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('images/Back.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #ecf0f1;
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    body::before { content: ''; position: absolute; inset: 0; background: rgba(44,62,80,0.85); z-index: -1; }

    .logo-container { text-align: center; margin-bottom: 20px; }
    .logo { max-width: 280px; height: auto; margin-bottom: 15px; }

    .interface-container {
      max-width: 95vw;
      margin: 0 auto;
      background: rgba(44,62,80,0.7);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    h1 { font-size: 2.8rem; margin-bottom: 12px; color: #3498db; }
    .subtitle { font-size: 1.4rem; opacity: 0.8; }

    .main-content {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      flex: 1;
    }

    .control-panel {
      flex: 0 0 350px;
      background: rgba(52,73,94,0.8);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .control-group { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .control-group:last-child { border-bottom: none; }
    h2 { font-size: 1.6rem; margin-bottom: 20px; color: #3498db; }
    label { display: block; margin-bottom: 12px; font-weight: 500; font-size: 1.2rem; }

    select, input[type="file"], input[type="range"], input[type="color"] {
      width: 100%; padding: 14px; margin-bottom: 20px;
      border: none; border-radius: 8px;
      background: #2c3e50; color: #ecf0f1;
      font-size: 1.1rem; min-height: 50px;
    }
    input[type="range"] { padding: 0; height: 16px; -webkit-appearance: none; background: #34495e; border-radius: 8px; }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 28px; height: 28px;
      border-radius: 50%; background: #3498db; cursor: pointer;
    }
    button {
      width: 100%; padding: 16px; background: #3498db; color: white;
      border: none; border-radius: 8px; font-size: 1.2rem; cursor: pointer;
      transition: background 0.3s; margin-bottom: 15px; min-height: 55px;
    }
    button:hover { background: #2980b9; }

    .color-preview { width: 50px; height: 50px; border-radius: 8px; border: 2px solid #ecf0f1; margin-top: 10px; }

    .preview-section { flex: 1; min-width: 350px; display: flex; flex-direction: column; }
    .preview-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      min-height: 450px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      overflow: auto;
      display: flex; justify-content: center; align-items: center;
      margin-bottom: 20px;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
      flex: 1;
    }

    #screenContainer { position: relative; transform-origin: center center; transition: transform 0.2s ease; max-width: 100%; max-height: 100%; }
    #maskImage, #fallbackCanvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; object-fit: contain; }
    #videoPlayer { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 2; }
    #previewCanvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 2; }

    .loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.7); color: white; padding: 20px 30px; border-radius: 10px; z-index: 5; display: none; font-size: 1.2rem; }
    .placeholder-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; color: rgba(255,255,255,0.6); z-index: 0; font-size: 1.2rem; }

    .screen-info { background: rgba(52,73,94,0.8); padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 20px; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
    .info-item { background: rgba(44,62,80,0.5); padding: 15px; border-radius: 10px; }
    .info-label { font-size: 1.1rem; opacity: 0.7; margin-bottom: 8px; }
    .info-value { font-size: 1.2rem; font-weight: 500; }

    .error-message { color: #e74c3c; margin-top: 15px; display: none; font-size: 1.1rem; }

    .control-panel-toggle { display: none; position: fixed; top: 20px; left: 20px; z-index: 1000; width: auto; padding: 14px 20px; background: #3498db; border-radius: 8px; font-size: 1.2rem; min-height: 50px; }
    .fullscreen-btn-container { text-align: center; margin-top: 15px; }
    #fullscreenBtn { width: auto; padding: 12px 25px; font-size: 1.2rem; min-height: 50px; }

    @media (max-width: 768px) {
      .main-content { flex-direction: column; }
      .control-panel {
        position: fixed; top: 0; left: -100%; width: 85%; max-width: 350px; height: 100vh;
        z-index: 999; overflow-y: auto; transition: left 0.3s ease;
      }
      .control-panel.active { left: 0; }
      .control-panel-toggle { display: block; }
      .preview-container { aspect-ratio: auto; height: 50vh; }
      .logo { max-width: 200px; }
      h1 { font-size: 2.2rem; }
      .subtitle { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <button class="control-panel-toggle" id="panelToggle" aria-label="Открыть панель управления">☰ Панель управления</button>

  <div class="interface-container">
    <div class="logo-container">
      <img src="images/connect_logo-1.jpg" alt="Connect Logo" class="logo"
           onerror="this.onerror=null;this.src='images/connect_logo-1.png'">
    </div>

    <header>
      <h1>Screen Preview с масштабированием</h1>
      <p class="subtitle">Просмотр контента на различных экранах с сохранением пропорций</p>
    </header>

    <div class="main-content">
      <div class="control-panel" id="controlPanel">
        <div class="control-group">
          <h2>Экран</h2>
          <label for="screenSelect">Выберите экран:</label>
          <select id="screenSelect">
            <option value="Bolshoi">Большой экран (6528×1472)</option>
            <option value="Poloski">Экран полоски (640×1920)</option>
            <option value="Nav">Навигация (316×384)</option>
            <option value="Bar1">Бар 1 (384×64)</option>
            <option value="Bar2">Бар 2 (256×64)</option>
            <option value="Recepshen">Рецепшен (2176×1280)</option>
            <option value="TualetM">Туалет мужской (284×256)</option>
            <option value="TualetW">Туалет женский (284×256)</option>
            <option value="TualetPotolok">Туалет потолок (383×384)</option>
            <option value="Lestnitsa">Экран на лестнице (200×120)</option>
          </select>

          <label for="uploadInput">Загрузить контент:</label>
          <input type="file" id="uploadInput" accept="image/*,video/*">
          <div class="error-message" id="uploadError"></div>
        </div>

        <div class="control-group">
          <h2>Масштаб</h2>
          <label for="scaleSlider">Масштаб: <span id="scaleValue">100%</span></label>
          <input type="range" id="scaleSlider" min="10" max="400" value="100">
          <button id="autoFitBtn">Автоподгон</button>
        </div>

        <div class="control-group">
          <h2>Внешний вид</h2>
          <label for="contentOpacity">Прозрачность: <span id="opacityValue">100%</span></label>
          <input type="range" id="contentOpacity" min="0" max="100" value="100">
          <label for="bgColor">Цвет фона:</label>
          <input type="color" id="bgColor" value="#2c3e50">
          <div class="color-preview" id="colorPreview"></div>
        </div>

        <div class="control-group">
          <h2>Системные</h2>
          <button id="resetBtn">Сбросить настройки</button>
        </div>
      </div>

      <div class="preview-section">
        <div class="preview-container" id="previewContainer">
          <div id="screenContainer">
            <div class="loading-indicator" id="loadingIndicator">Загрузка маски экрана...</div>
            <img id="maskImage" src="" alt="Mask" onerror="handleImageError()" style="object-fit: contain;">
            <video id="videoPlayer" controls></video>
            <canvas id="previewCanvas"></canvas>
            <div class="placeholder-message" id="placeholderMessage">
              <h3>Загрузите контент</h3>
              <p>Перетащите файл сюда или используйте кнопку загрузки</p>
            </div>
          </div>
        </div>

        <div class="screen-info">
          <div class="info-grid">
            <div class="info-item"><div class="info-label">Текущий экран</div><div class="info-value" id="currentScreen">Большой экран</div></div>
            <div class="info-item"><div class="info-label">Разрешение</div><div class="info-value" id="screenResolution">6528 × 1472</div></div>
            <div class="info-item"><div class="info-label">Соотношение</div><div class="info-value" id="aspectRatio">102:23</div></div>
            <div class="info-item"><div class="info-label">Масштаб</div><div class="info-value" id="scalePercent">100%</div></div>
          </div>
        </div>

        <div class="fullscreen-btn-container">
          <button id="fullscreenBtn">Полный экран</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const maskCache = {};
    const smallScreens = ['Nav','Bar1','Bar2','TualetM','TualetW','TualetPotolok','Lestnitsa'];
    let currentFileURL = null;

    const screens = {
      Bolshoi: { w:6528, h:1472, src:'images/Bolshoi-ekran-6528kh1472.jpg', ratio:"102:23" },
      Poloski: { w:640,  h:1920, src:'images/Ekran-poloski-640x1920.jpg', ratio:"1:3" },
      Nav: { w:316,  h:384,  src:'images/Navigation-316x384.jpg', ratio:"79:96" },
      Bar1:{ w:384,  h:64,   src:'images/Bar 1 384x64.jpg', ratio:"6:1" },
      Bar2:{ w:256,  h:64,   src:'images/Bar-2-256Kh64.jpg', ratio:"4:1" },
      Recepshen:{ w:2176, h:1280, src:'images/Recepshen-2176x1280.jpg', ratio:"17:10" },
      TualetM:{ w:284,  h:256,  src:'images/Tualet-men-284x256.jpg', ratio:"71:64" },
      TualetW:{ w:284,  h:256,  src:'images/Tualet-women-284x256.jpg', ratio:"71:64" },
      TualetPotolok:{ w:383,  h:384,  src:'images/Tualet-potolok-383x384.jpg', ratio:"383:384" },
      Lestnitsa:{ w:200,  h:120,  src:'images/Ekran-na-lestnice-200Kh120-1920Kh1080.jpg', ratio:"5:3" }
    };

    const sel = document.getElementById('screenSelect');
    const inFile = document.getElementById('uploadInput');
    const cont = document.getElementById('screenContainer');
    const maskImg = document.getElementById('maskImage');
    const vid = document.getElementById('videoPlayer');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const scaleSlider = document.getElementById('scaleSlider');
    const scaleValue = document.getElementById('scaleValue');
    const autoFitBtn = document.getElementById('autoFitBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const opacitySlider = document.getElementById('contentOpacity');
    const opacityValue = document.getElementById('opacityValue');
    const bgColorPicker = document.getElementById('bgColor');
    const colorPreview = document.getElementById('colorPreview');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const placeholderMessage = document.getElementById('placeholderMessage');
    const uploadError = document.getElementById('uploadError');
    const panelToggle = document.getElementById('panelToggle');
    const controlPanel = document.getElementById('controlPanel');
    const currentScreen = document.getElementById('currentScreen');
    const screenResolution = document.getElementById('screenResolution');
    const aspectRatio = document.getElementById('aspectRatio');
    const scalePercent = document.getElementById('scalePercent');
    const previewContainer = document.getElementById('previewContainer');
    const resetBtn = document.getElementById('resetBtn');

    let isPortrait = window.innerHeight > window.innerWidth;
    let resizeTimeout;
    let currentScreenType = sel.value;

    panelToggle.addEventListener('click', () => controlPanel.classList.toggle('active'));
    window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(()=>{ isPortrait=window.innerHeight>window.innerWidth; },200); });

    // drag & drop загрузка
    previewContainer.addEventListener('dragover', e => { e.preventDefault(); previewContainer.style.border="2px dashed #3498db"; });
    previewContainer.addEventListener('dragleave', e => { previewContainer.style.border="none"; });
    previewContainer.addEventListener('drop', e => {
      e.preventDefault();
      previewContainer.style.border="none";
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    inFile.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

    scaleSlider.addEventListener('input', () => {
      scaleValue.textContent = scaleSlider.value + '%';
      scalePercent.textContent = scaleSlider.value + '%';
      cont.style.transform = `scale(${scaleSlider.value/100})`;
      saveSettings();
    });

    autoFitBtn.addEventListener('click', autoFit);

    opacitySlider.addEventListener('input', () => {
      const val = opacitySlider.value;
      opacityValue.textContent = val+'%';
      vid.style.opacity = val/100;
      canvas.style.opacity = val/100;
      saveSettings();
    });

    bgColorPicker.addEventListener('input', () => {
      previewContainer.style.background = bgColorPicker.value;
      colorPreview.style.background = bgColorPicker.value;
      saveSettings();
    });

    fullscreenBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) previewContainer.requestFullscreen().catch(console.error);
      else document.exitFullscreen();
    });

    sel.addEventListener('change', () => {
      currentScreenType = sel.value;
      updateScreen();
      saveSettings();
    });

    function handleFile(file){
      if (currentFileURL) URL.revokeObjectURL(currentFileURL);
      currentFileURL = URL.createObjectURL(file);
      uploadError.style.display="none";
      placeholderMessage.style.display="none";

      if (file.type.startsWith("video/")) {
        vid.src = currentFileURL; vid.style.display="block"; canvas.style.display="none";
      } else if (file.type.startsWith("image/")) {
        const img=new Image();
        img.onload=()=>{
          canvas.width=img.width; canvas.height=img.height;
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0);
          vid.style.display="none"; canvas.style.display="block";
        };
        img.onerror=()=>{ uploadError.textContent="Ошибка загрузки изображения."; uploadError.style.display="block"; };
        img.src=currentFileURL;
      } else {
        uploadError.textContent="Неподдерживаемый тип файла. Загрузите изображение или видео.";
        uploadError.style.display="block";
      }
    }

    function updateScreen(){
      const scr=screens[currentScreenType];
      currentScreen.textContent=sel.options[sel.selectedIndex].text;
      screenResolution.textContent=`${scr.w} × ${scr.h}`;
      aspectRatio.textContent=scr.ratio;
      loadingIndicator.style.display="block";
      placeholderMessage.style.display=(!vid.src&&!canvas.width)?"block":"none";

      if(maskCache[currentScreenType]){ maskImg.src=maskCache[currentScreenType]; loadingIndicator.style.display="none"; }
      else{
        maskImg.onload=()=>{ maskCache[currentScreenType]=scr.src; loadingIndicator.style.display="none"; };
        maskImg.onerror=()=>{ loadingIndicator.style.display="none"; };
        maskImg.src=scr.src;
      }
      autoFit();
    }

    function autoFit(){
      const scr=screens[currentScreenType];
      const pcRect=previewContainer.getBoundingClientRect();
      const scale=Math.min(pcRect.width/scr.w, pcRect.height/scr.h)*100;
      scaleSlider.value=Math.floor(scale);
      scaleValue.textContent=scaleSlider.value+'%';
      scalePercent.textContent=scaleSlider.value+'%';
      cont.style.transform=`scale(${scaleSlider.value/100})`;
      saveSettings();
    }

    function saveSettings(){
      localStorage.setItem("screenSettings", JSON.stringify({
        screenType: currentScreenType,
        scale: scaleSlider.value,
        opacity: opacitySlider.value,
        bgColor: bgColorPicker.value
      }));
    }

    function loadSettings(){
      const saved=localStorage.getItem("screenSettings");
      if(saved){
        try{
          const st=JSON.parse(saved);
          if(st.screenType && screens[st.screenType]){ sel.value=st.screenType; currentScreenType=st.screenType; }
          if(st.scale){ scaleSlider.value=st.scale; scaleValue.textContent=st.scale+'%'; scalePercent.textContent=st.scale+'%'; cont.style.transform=`scale(${st.scale/100})`; }
          if(st.opacity){ opacitySlider.value=st.opacity; opacityValue.textContent=st.opacity+'%'; vid.style.opacity=st.opacity/100; canvas.style.opacity=st.opacity/100; }
          if(st.bgColor){ bgColorPicker.value=st.bgColor; previewContainer.style.background=st.bgColor; colorPreview.style.background=st.bgColor; }
        }catch(e){ console.error("Ошибка загрузки настроек:",e); }
      }
      updateScreen();
    }

    resetBtn.addEventListener("click", () => {
      localStorage.removeItem("screenSettings");
      sel.value = "Bolshoi";
      currentScreenType = "Bolshoi";
      scaleSlider.value = 100;
      scaleValue.textContent = "100%";
      scalePercent.textContent = "100%";
      cont.style.transform = "scale(1)";
      opacitySlider.value = 100;
      opacityValue.textContent = "100%";
      vid.style.opacity = 1;
      canvas.style.opacity = 1;
      bgColorPicker.value = "#2c3e50";
      previewContainer.style.background = "#2c3e50";
      colorPreview.style.background = "#2c3e50";
      updateScreen();
    });

    loadSettings();
  </script>
</body>
</html>
